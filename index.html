<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PresuPro v2</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            overscroll-behavior-y: contain;
        }
        input, textarea {
            user-select: text;
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        ::-webkit-scrollbar {
            display: none;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden antialiased">

    <div id="splash" class="fixed inset-0 bg-blue-600 z-[100] flex items-center justify-center transition-opacity duration-500">
        <div class="text-white text-center">
            <h1 class="text-4xl font-black italic tracking-tighter uppercase">Presu<span class="text-blue-200">Pro</span></h1>
            <div class="mt-4 animate-spin h-6 w-6 border-4 border-white border-t-transparent rounded-full mx-auto"></div>
        </div>
    </div>

    <div id="auth-screen" class="fixed inset-0 bg-slate-900 z-[90] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="text-3xl mb-2">üîê</div>
                <h2 class="text-2xl font-black text-slate-800 uppercase italic leading-none">Acceso<br><span class="text-blue-600">Restringido</span></h2>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-2">Ingresa tus credenciales</p>
            </div>
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Correo Electr√≥nico</label>
                    <input type="email" id="auth-email" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Contrase√±a</label>
                    <input type="password" id="auth-pass" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm shadow-lg active:scale-95 transition-all">
                    Entrar al Sistema
                </button>
            </form>
            <p class="text-center text-[9px] text-slate-400 mt-6 uppercase font-bold tracking-tighter">Software Protegido por Licencia PresuPro</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="fixed bottom-0 shrink-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 no-print">
            <button onclick="nuevaFactura()" class="flex flex-col items-center text-blue-600">
                <span class="text-xl">üìù</span>
                <span class="text-[10px] font-bold uppercase">Nueva</span>
            </button>
            <button onclick="openModal('modalInventory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">üì¶</span>
                <span class="text-[10px] font-bold uppercase">Inventario</span>
            </button>
            <button onclick="openModal('modalHistory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">üîç</span>
                <span class="text-[10px] font-bold uppercase">Historial</span>
            </button>
            <button onclick="openModal('modalSettings')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">‚öôÔ∏è</span>
                <span class="text-[10px] font-bold uppercase">Ajustes</span>
            </button>
        </nav>

        <main id="view-calc" class="p-4 pb-24 max-w-xl mx-auto min-h-screen">
            <header id="header-design" class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-blue-600 mb-6 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-2xl bg-slate-100 flex items-center justify-center overflow-hidden border">
                        <img id="logo-img" src="" class="hidden w-full h-full object-contain">
                        <span id="logo-txt" class="text-[10px] font-bold text-slate-400 text-center px-1">LOGO</span>
                    </div>
                    <div>
                        <h2 id="display-company" class="text-xl font-black uppercase leading-none text-blue-600">Mi Empresa</h2>
                        <p id="display-date" class="text-[10px] font-mono text-slate-400 mt-1 uppercase"></p>
                    </div>
                </div>
            </header>

            <button onclick="openModal('modalClient')" class="w-full bg-white border-2 border-dashed border-slate-200 p-4 rounded-2xl mb-6 flex justify-between items-center active:scale-95 transition-transform">
                <div class="text-left">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Cliente:</p>
                    <p id="display-client-name" class="font-bold text-slate-700 uppercase italic text-sm">A√±adir datos del cliente</p>
                    <p id="display-client-id-text" class="text-[9px] text-slate-400 uppercase"></p>
                </div>
                <span class="text-blue-500 text-xl">üë§</span>
            </button>

            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2">Lista de Materiales</h3>
            <div id="items-container" class="space-y-3"></div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="addItemRow('externo')" class="py-4 bg-white border-2 border-slate-300 border-dashed rounded-2xl text-slate-600 font-bold text-[10px] uppercase hover:bg-slate-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg">üõí</span> Compra Externa
                </button>
                <button onclick="openModal('modalInventory')" class="py-4 bg-white border-2 border-blue-600 border-dashed rounded-2xl text-blue-600 font-bold text-[10px] uppercase hover:bg-blue-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg">üì¶</span> Mi Inventario
                </button>
            </div>

            <div class="mt-8 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4">C√°lculo de Mano de Obra</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">METROS CUADRADOS (m2)</label>
                        <input type="number" id="mo-m2" oninput="saveAndCalc()" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">PRECIO POR m2 ($)</label>
                        <input type="number" id="mo-price" oninput="saveAndCalc()" placeholder="0.00" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-slate-900 text-white p-6 rounded-[2rem] shadow-2xl">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total General</p>
                        <h2 id="total-amount" class="text-3xl font-black text-white">$ 0.00</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Tasa del d√≠a</p>
                        <input type="number" id="tasa-cambio" value="60" oninput="saveAndCalc()" class="bg-transparent text-right font-black text-xl w-20 outline-none border-b border-blue-500/30">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="btn-generate-pdf" onclick="enviarAlServidor()" class="py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span>üì•</span> PDF
                    </button>
                    <button id="btn-save-invoice" onclick="guardarFacturaFirebase()" class="py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span>üíæ</span> GUARDAR
                    </button>
                </div>

                <div class="pt-4 border-t border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase italic">Monto en BS:</span>
                    <span id="total-converted" class="text-xl font-black text-blue-400">BS 0.00</span>
                </div>
            </div>

            <footer class="mt-12 text-center pb-10">
                <p class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-1">PresuPro v2.0</p>
                <p class="text-[9px] font-bold text-blue-400/50 uppercase">Conexi√≥n con Servidor Render Activa</p>
            </footer>
        </main>
    </div>

    <div id="modalClient" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up">
            <h3 class="font-black uppercase text-slate-800 mb-4">Informaci√≥n del Cliente</h3>
            <div class="space-y-3">
                <input type="text" id="in-client-id" placeholder="C√©dula / ID" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-name" placeholder="Nombre Completo" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-dir" placeholder="Direcci√≥n" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <button onclick="saveClientData()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm mt-2">Listo</button>
                <button onclick="closeModal('modalClient')" class="w-full text-slate-400 font-bold text-[10px] uppercase">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalInventory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Mi Inventario</h3>
                <button onclick="closeModal('modalInventory')" class="text-2xl">&times;</button>
            </div>
            <div class="bg-slate-100 p-4 rounded-2xl mb-4 space-y-2">
                <input type="text" id="inv-name" placeholder="Nombre Producto" class="w-full p-2 rounded-lg text-xs uppercase font-bold outline-none">
                <div class="flex gap-2">
                    <input type="number" id="inv-qty" placeholder="Stock" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                    <input type="number" id="inv-price" placeholder="Precio $" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                </div>
                <button id="btn-add-inv" onclick="addToInventory()" class="w-full bg-slate-800 text-white text-[10px] font-bold py-2 rounded-lg uppercase">+ Guardar en Stock</button>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="modalHistory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Historial de Facturas</h3>
                <button onclick="closeModal('modalHistory')" class="text-2xl">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <div id="modalSettings" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
            <h3 class="font-black uppercase mb-4">Configuraci√≥n</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Nombre de Empresa</label>
                    <input type="text" id="in-comp-name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Logo de Empresa</label>
                    <input type="file" id="in-comp-logo" onchange="previewLogo(this)" class="w-full text-xs mt-1" accept="image/*">
                </div>
                <button onclick="saveSettings()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm">Guardar Cambios</button>
                <button onclick="handleLogout()" class="w-full bg-red-50 text-red-600 font-black py-4 rounded-2xl uppercase text-sm mt-4">Cerrar Sesi√≥n</button>
                <button onclick="closeModal('modalSettings')" class="w-full text-slate-400 font-bold text-[10px] uppercase">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence, collection, addDoc, getDocs, query, where, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTfukrycpMrtYZ6vuF06knIxi4-g8TLLs",
            authDomain: "presuproapp.firebaseapp.com",
            projectId: "presuproapp",
            storageBucket: "presuproapp.firebasestorage.app",
            messagingSenderId: "56089233501",
            appId: "1:56089233501:web:363348f4daf2b6bb9825b4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        enableIndexedDbPersistence(db).catch(() => console.log("Persistencia ya habilitada"));

        window.db = db;
        window.auth = auth;

        // --- FUNCIONES GLOBALES (ACCESIBLES DESDE EL HTML) ---

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('btn-login');
            
            btn.disabled = true;
            btn.innerText = "Verificando...";
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("Error de acceso: Credenciales inv√°lidas");
                btn.disabled = false;
                btn.innerText = "Entrar al Sistema";
            }
        };

        window.handleLogout = () => {
            if(confirm("¬øCerrar sesi√≥n?")) signOut(auth);
        };

        window.saveSettings = async () => {
            const nombre = document.getElementById('in-comp-name').value;
            const logo = document.getElementById('logo-img').src;
            
            try {
                // Guardamos en un documento √∫nico por usuario
                await setDoc(doc(db, "settings", window.currentUser), {
                    userId: window.currentUser,
                    nombre: nombre,
                    logo: logo
                });
                alert("Configuraci√≥n guardada");
                location.reload();
            } catch (e) {
                alert("Error al guardar ajustes");
            }
        };

        window.previewLogo = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('logo-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('logo-txt').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        onAuthStateChanged(auth, (user) => {
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const splash = document.getElementById('splash');

            setTimeout(() => {
                if (splash) splash.style.opacity = '0';
                setTimeout(() => splash?.remove(), 500);
            }, 1500);

            if (user) {
                window.currentUser = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                document.getElementById('display-date').innerText = new Date().toLocaleDateString();
                
                loadSettings();
                loadInventory();
                loadHistory(); 
            } else {
                window.currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });

        async function loadInventory() {
            if(!window.currentUser) return;
            const q = query(collection(db, "inventory"), where("userId", "==", window.currentUser));
            const querySnapshot = await getDocs(q);
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            querySnapshot.forEach((doc) => {
                const item = doc.data();
                list.innerHTML += `
                    <div class="bg-slate-50 p-3 rounded-xl border flex justify-between items-center">
                        <div>
                            <p class="font-bold text-xs uppercase">${item.name}</p>
                            <p class="text-[10px] text-slate-400">STOCK: ${item.qty} | $${item.price}</p>
                        </div>
                        <button onclick="addFromInventory('${item.name}', ${item.price})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase">A√±adir</button>
                    </div>
                `;
            });
        }
        window.loadInventory = loadInventory;

        window.addToInventory = async () => {
            const name = document.getElementById('inv-name').value;
            const qty = document.getElementById('inv-qty').value;
            const price = document.getElementById('inv-price').value;
            if(!name || !qty || !price) return alert("Completa los datos");

            await addDoc(collection(db, "inventory"), {
                userId: window.currentUser,
                name: name.toUpperCase(),
                qty: Number(qty),
                price: Number(price)
            });
            loadInventory();
            document.getElementById('inv-name').value = '';
            document.getElementById('inv-qty').value = '';
            document.getElementById('inv-price').value = '';
        };

        async function loadHistory() {
            if(!window.currentUser) return;
            const q = query(collection(db, "invoices"), where("userId", "==", window.currentUser));
            const querySnapshot = await getDocs(q);
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const inv = docSnap.data();
                list.innerHTML += `
                    <div class="bg-slate-50 p-4 rounded-2xl border flex justify-between items-center">
                        <div>
                            <p class="font-black text-sm uppercase">${inv.cliente.nombre || 'Sin Nombre'}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${inv.fecha}</p>
                            <p class="text-blue-600 font-black text-xs">$ ${Number(inv.total).toFixed(2)}</p>
                        </div>
                        <button onclick='alert("Funci√≥n Visualizar en desarrollo...")' class="bg-slate-800 text-white p-2 rounded-xl">üëÅÔ∏è</button>
                    </div>
                `;
            });
        }
        window.loadHistory = loadHistory;

        window.guardarFacturaFirebase = async () => {
            const data = prepararDatos();
            if(!data.cliente.nombre || data.cliente.nombre === "A√±adir datos del cliente") return alert("Asigna un nombre al cliente");
            
            try {
                await addDoc(collection(db, "invoices"), {
                    ...data,
                    userId: window.currentUser,
                    fecha: new Date().toLocaleDateString()
                });
                alert("Factura guardada con √©xito");
                loadHistory();
            } catch(e) { alert("Error al guardar en la nube"); }
        }

        async function loadSettings() {
            const q = query(collection(db, "settings"), where("userId", "==", window.currentUser));
            const snap = await getDocs(q);
            snap.forEach(doc => {
                const s = doc.data();
                document.getElementById('display-company').innerText = s.nombre;
                document.getElementById('in-comp-name').value = s.nombre;
                if(s.logo) {
                    const img = document.getElementById('logo-img');
                    img.src = s.logo;
                    img.classList.remove('hidden');
                    document.getElementById('logo-txt').classList.add('hidden');
                }
            });
        }
    </script>

    <script>
        // L√ìGICA DE LA CALCULADORA (SIN CAMBIOS ESTRUCTURALES)
        function addItemRow(tipo) {
            const container = document.getElementById('items-container');
            const id = Date.now();
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = "bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-3 items-center animate-slide-up";
            
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" placeholder="NOMBRE DEL MATERIAL" class="w-full text-[10px] font-black uppercase outline-none mb-1 item-name">
                    <div class="flex gap-2">
                        <input type="number" placeholder="CANT" oninput="saveAndCalc()" class="w-16 p-1 bg-slate-50 rounded font-bold text-xs item-qty">
                        <input type="number" placeholder="PRECIO $" oninput="saveAndCalc()" class="w-24 p-1 bg-slate-50 rounded font-bold text-xs item-price">
                    </div>
                </div>
                <button onclick="removeRow('${id}')" class="text-red-400">‚úï</button>
            `;
            container.appendChild(div);
        }

        function addFromInventory(name, price) {
            const container = document.getElementById('items-container');
            const id = Date.now();
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = "bg-blue-50 p-4 rounded-2xl shadow-sm border border-blue-100 flex gap-3 items-center animate-slide-up";
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" value="${name}" class="w-full text-[10px] font-black uppercase outline-none mb-1 item-name" readonly>
                    <div class="flex gap-2">
                        <input type="number" placeholder="CANT" oninput="saveAndCalc()" class="w-16 p-1 bg-white rounded font-bold text-xs item-qty">
                        <input type="number" value="${price}" oninput="saveAndCalc()" class="w-24 p-1 bg-white rounded font-bold text-xs item-price">
                    </div>
                </div>
                <button onclick="removeRow('${id}')" class="text-red-400">‚úï</button>
            `;
            container.appendChild(div);
            closeModal('modalInventory');
            saveAndCalc();
        }

        function removeRow(id) {
            document.getElementById(`row-${id}`).remove();
            saveAndCalc();
        }

        function prepararDatos() {
            const mats = [];
            document.querySelectorAll('#items-container > div').forEach(row => {
                mats.push({
                    nombre: row.querySelector('.item-name').value,
                    cantidad: row.querySelector('.item-qty').value,
                    precio: row.querySelector('.item-price').value
                });
            });

            return {
                cliente: {
                    nombre: document.getElementById('display-client-name').innerText,
                    id: document.getElementById('display-client-id-text').innerText,
                },
                materiales: mats,
                manoObra: {
                    metros: document.getElementById('mo-m2').value,
                    precioPorMetro: document.getElementById('mo-price').value
                },
                tasa: document.getElementById('tasa-cambio').value,
                total: parseFloat(document.getElementById('total-amount').innerText.replace('$ ', '')) || 0,
                empresa: {
                    nombre: document.getElementById('display-company').innerText,
                    logo: document.getElementById('logo-img').src
                }
            };
        }

        function saveAndCalc() {
            const data = prepararDatos();
            let subtotalMats = 0;
            data.materiales.forEach(m => {
                subtotalMats += (Number(m.cantidad) * Number(m.precio));
            });
            const totalMO = Number(data.manoObra.metros) * Number(data.manoObra.precioPorMetro);
            const totalUSD = subtotalMats + totalMO;
            const tasa = Number(data.tasa) || 1;

            document.getElementById('total-amount').innerText = `$ ${totalUSD.toFixed(2)}`;
            document.getElementById('total-converted').innerText = `BS ${(totalUSD * tasa).toFixed(2)}`;
        }

        function enviarAlServidor() {
            const data = prepararDatos();
            fetch('/generar-presupuesto', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.text())
            .then(html => {
                const win = window.open('', '_blank');
                win.document.write(html);
                win.document.close();
            });
        }

        function saveClientData() {
            const id = document.getElementById('in-client-id').value;
            const name = document.getElementById('in-client-name').value;
            document.getElementById('display-client-name').innerText = name || "A√±adir datos del cliente";
            document.getElementById('display-client-id-text').innerText = id ? `ID: ${id}` : "";
            closeModal('modalClient');
        }

        function nuevaFactura() {
            if(confirm("¬øLimpiar todo para una nueva factura?")) {
                document.getElementById('items-container').innerHTML = '';
                document.getElementById('mo-m2').value = '';
                document.getElementById('mo-price').value = '';
                document.getElementById('display-client-name').innerText = "A√±adir datos del cliente";
                document.getElementById('display-client-id-text').innerText = "";
                saveAndCalc();
            }
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>