<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PresuPro v2</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            overscroll-behavior-y: contain;
        }
        input, textarea {
            user-select: text;
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        ::-webkit-scrollbar {
            display: none;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        @media print {
            .no-print { display: none !important; }
        }

        /* Contenedor para la generaci√≥n de la imagen profesional (Oculto en la interfaz) */
        #render-invoice {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px;
            background: white;
            padding: 40px;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
        }
        .table-pro th { border-bottom: 2px solid #2563eb; padding: 10px; font-size: 12px; text-transform: uppercase; color: #64748b; text-align: left; }
        .table-pro td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden antialiased">

    <div id="render-invoice">
        <div class="flex justify-between items-start mb-8 border-b-4 border-blue-600 pb-6">
            <div>
                <img id="pro-logo" src="" class="h-20 object-contain hidden mb-4">
                <h1 id="pro-company" class="text-3xl font-black text-slate-800 uppercase italic"></h1>
            </div>
            <div class="text-right">
                <h2 class="text-5xl font-black text-slate-100 uppercase tracking-tighter text-blue-600/10">Cotizaci√≥n</h2>
                <p id="pro-date" class="font-mono text-sm text-slate-500 mt-2"></p>
            </div>
        </div>
        <div class="bg-slate-50 p-6 rounded-3xl mb-8 flex justify-between border border-slate-100">
            <div>
                <p class="text-[10px] font-black text-blue-600 uppercase mb-1">Cliente</p>
                <p id="pro-client-name" class="text-lg font-black uppercase text-slate-800"></p>
                <p id="pro-client-id" class="text-xs font-bold text-slate-400"></p>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-black text-blue-600 uppercase mb-1">Ubicaci√≥n</p>
                <p id="pro-client-dir" class="text-xs font-bold text-slate-500"></p>
            </div>
        </div>
        <table class="w-full table-pro mb-8">
            <thead>
                <tr>
                    <th class="w-16">Cant.</th>
                    <th>Descripci√≥n</th>
                    <th class="text-right">Unitario</th>
                    <th class="text-right">Subtotal</th>
                </tr>
            </thead>
            <tbody id="pro-items-body"></tbody>
        </table>
        <div id="pro-mo-box" class="mb-8 p-6 bg-blue-50 rounded-3xl border border-blue-100 hidden flex justify-between items-center">
            <p id="pro-mo-desc" class="text-sm font-bold text-slate-600"></p>
            <p id="pro-mo-total" class="text-xl font-black text-slate-800"></p>
        </div>
        <div class="flex justify-end">
            <div class="w-80 space-y-3 text-right">
                <div class="flex justify-between px-4 text-slate-400 font-black uppercase text-xs">
                    <span>Total USD:</span><span id="pro-total-usd" class="text-slate-800 text-xl font-bold"></span>
                </div>
                <div class="bg-slate-900 p-6 rounded-[2rem] text-white flex justify-between items-center">
                    <span id="pro-total-bs" class="text-3xl font-black w-full text-center"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="splash" class="fixed inset-0 bg-blue-600 z-[100] flex items-center justify-center transition-opacity duration-500">
        <div class="text-white text-center">
            <h1 class="text-4xl font-black italic tracking-tighter uppercase">Presu<span class="text-blue-200">Pro</span></h1>
            <div class="mt-4 animate-spin h-6 w-6 border-4 border-white border-t-transparent rounded-full mx-auto"></div>
        </div>
    </div>

    <div id="auth-screen" class="fixed inset-0 bg-slate-900 z-[90] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="text-3xl mb-2">üîë</div>
                <h2 class="text-2xl font-black text-slate-800 uppercase italic leading-none">Acceso<br><span class="text-blue-600">Restringido</span></h2>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-2">Ingresa tus credenciales</p>
            </div>
            <form onsubmit="event.preventDefault(); window.handleLogin();" class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Correo Electr√≥nico</label>
                    <input type="email" id="auth-email" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Contrase√±a</label>
                    <input type="password" id="auth-pass" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm shadow-lg active:scale-95 transition-all">
                    Entrar al Sistema
                </button>
            </form>
            <p class="text-center text-[9px] text-slate-400 mt-6 uppercase font-bold tracking-tighter">Software Protegido por Licencia PresuPro</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="fixed bottom-0 shrink-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 no-print">
            <button onclick="window.nuevaFactura()" class="flex flex-col items-center text-blue-600">
                <span class="text-xl">üìÑ</span>
                <span class="text-[10px] font-bold uppercase">Nueva</span>
            </button>
            <button onclick="window.openModal('modalInventory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">üì¶</span>
                <span class="text-[10px] font-bold uppercase">Inventario</span>
            </button>
            <button onclick="window.openModal('modalHistory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">üìã</span>
                <span class="text-[10px] font-bold uppercase">Historial</span>
            </button>
            <button onclick="window.openModal('modalSettings')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">‚öôÔ∏è</span>
                <span class="text-[10px] font-bold uppercase">Ajustes</span>
            </button>
        </nav>

        <main id="view-calc" class="p-4 pb-24 max-w-xl mx-auto min-h-screen">
            <header id="header-design" class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-blue-600 mb-6 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-2xl bg-slate-100 flex items-center justify-center overflow-hidden border">
                        <img id="logo-img" src="" class="hidden w-full h-full object-contain">
                        <span id="logo-txt" class="text-[10px] font-bold text-slate-400 text-center px-1">LOGO</span>
                    </div>
                    <div>
                        <h2 id="display-company" class="text-xl font-black uppercase leading-none text-blue-600">Mi Empresa</h2>
                        <p id="display-date" class="text-[10px] font-mono text-slate-400 mt-1 uppercase"></p>
                    </div>
                </div>
            </header>

            <button onclick="window.openModal('modalClient')" class="w-full bg-white border-2 border-dashed border-slate-200 p-4 rounded-2xl mb-6 flex justify-between items-center active:scale-95 transition-transform">
                <div class="text-left">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Cliente:</p>
                    <p id="display-client-name" class="font-bold text-slate-700 uppercase italic text-sm">A√±adir datos del cliente</p>
                    <p id="display-client-id-text" class="text-[9px] text-slate-400 uppercase"></p>
                </div>
                <span class="text-blue-500 text-xl">üë§</span>
            </button>

            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2">Lista de Materiales</h3>
            <div id="items-container" class="space-y-3"></div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="window.addItemRow('externo')" class="py-4 bg-white border-2 border-slate-300 border-dashed rounded-2xl text-slate-600 font-bold text-[10px] uppercase hover:bg-slate-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg">üõí</span> Compra Externa
                </button>
                <button onclick="window.openModal('modalInventory')" class="py-4 bg-white border-2 border-blue-600 border-dashed rounded-2xl text-blue-600 font-bold text-[10px] uppercase hover:bg-blue-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg">üè¨</span> Mi Inventario
                </button>
            </div>

            <div class="mt-8 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4">C√°lculo de Mano de Obra</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">METROS CUADRADOS (m2)</label>
                        <input type="number" id="mo-m2" oninput="window.saveAndCalc()" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">PRECIO POR m2 ($)</label>
                        <input type="number" id="mo-price" oninput="window.saveAndCalc()" placeholder="0.00" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-slate-900 text-white p-6 rounded-[2rem] shadow-2xl">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total General</p>
                        <h2 id="total-amount" class="text-3xl font-black text-white">$ 0.00</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Tasa del d√≠a</p>
                        <input type="number" id="tasa-cambio" value="60" oninput="window.saveAndCalc()" class="bg-transparent text-right font-black text-xl w-20 outline-none border-b border-blue-500/30">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="btn-generate-pdf" onclick="window.enviarAlServidor()" class="py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span>üñºÔ∏è</span> IMAGEN
                    </button>
                    <button id="btn-save-invoice" onclick="window.guardarFacturaFirebase()" class="py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span>üíæ</span> GUARDAR
                    </button>
                </div>

                <div class="pt-4 border-t border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase italic">Monto en BS:</span>
                    <span id="total-converted" class="text-xl font-black text-blue-400">BS 0.00</span>
                </div>
            </div>

            <footer class="mt-12 text-center pb-10">
                <p class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-1">PresuPro v2.0</p>
                <p class="text-[9px] font-bold text-blue-400/50 uppercase">Conexi√≥n Segura Activa</p>
            </footer>
        </main>
    </div>

    <div id="modalClient" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up">
            <h3 class="font-black uppercase text-slate-800 mb-4">Informaci√≥n del Cliente</h3>
            <div class="space-y-3">
                <input type="text" id="in-client-id" placeholder="C√©dula / ID" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-name" placeholder="Nombre Completo" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-dir" placeholder="Direcci√≥n" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <button onclick="window.saveClientData()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm mt-2">Listo</button>
                <button onclick="window.closeModal('modalClient')" class="w-full text-slate-400 font-bold text-[10px] uppercase">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalInventory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Mi Inventario</h3>
                <button onclick="window.closeModal('modalInventory')" class="text-2xl">&times;</button>
            </div>
            <div class="bg-slate-100 p-4 rounded-2xl mb-4 space-y-2">
                <input type="text" id="inv-name" placeholder="Nombre Producto" class="w-full p-2 rounded-lg text-xs uppercase font-bold outline-none">
                <div class="flex gap-2">
                    <input type="number" id="inv-qty" placeholder="Stock" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                    <input type="number" id="inv-price" placeholder="Precio $" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                </div>
                <button id="btn-add-inv" onclick="window.addToInventory()" class="w-full bg-slate-800 text-white text-[10px] font-bold py-2 rounded-lg uppercase">+ Guardar en Stock</button>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="modalHistory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Historial de Facturas</h3>
                <button onclick="window.closeModal('modalHistory')" class="text-2xl">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <div id="modalSettings" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
            <h3 class="font-black uppercase mb-4">Configuraci√≥n</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Nombre de Empresa</label>
                    <input type="text" id="in-comp-name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Logo de Empresa</label>
                    <input type="file" id="in-comp-logo" onchange="window.previewLogo(this)" class="w-full text-xs mt-1" accept="image/*">
                </div>
                <button onclick="window.saveSettings()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm">Guardar Cambios</button>
                <button onclick="window.handleLogout()" class="w-full bg-red-50 text-red-600 font-black py-4 rounded-2xl uppercase text-sm mt-4">Cerrar Sesi√≥n</button>
                <button onclick="window.closeModal('modalSettings')" class="w-full text-slate-400 font-bold text-[10px] uppercase">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence, collection, addDoc, getDocs, query, where, doc, setDoc, deleteDoc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTfukrycpMrtYZ6vuF06knIxi4-g8TLLs",
            authDomain: "presuproapp.firebaseapp.com",
            projectId: "presuproapp",
            storageBucket: "presuproapp.firebasestorage.app",
            messagingSenderId: "56089233501",
            appId: "1:56089233501:web:363348f4daf2b6bb9825b4"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        enableIndexedDbPersistence(db).catch(() => console.log("Persistencia ya habilitada"));

        window.db = db;
        window.auth = auth;

        window.currentEditingInvoiceId = null;

        // GLOBALIZACI√ìN DE FUNCIONES (CORRECCI√ìN DEL ERROR DE SCOPE)
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('btn-login');
            btn.disabled = true;
            btn.innerText = "Verificando...";
            try { 
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("Error de acceso: Credenciales inv√°lidas");
                btn.disabled = false;
                btn.innerText = "Entrar al Sistema";
            }
        };

        window.handleLogout = () => { if(confirm("¬øCerrar sesi√≥n?")) signOut(auth); };

        window.saveSettings = async () => {
            const nombre = document.getElementById('in-comp-name').value;
            const logo = document.getElementById('logo-img').src;
            try {
                await setDoc(doc(db, "settings", window.currentUser), {
                    userId: window.currentUser, nombre: nombre, logo: logo
                });
                alert("Configuraci√≥n guardada");
                location.reload();
            } catch (e) { alert("Error al guardar ajustes"); }
        };

        window.previewLogo = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('logo-img');
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('logo-txt').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        onAuthStateChanged(auth, (user) => {
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const splash = document.getElementById('splash');
            setTimeout(() => {
                if (splash) splash.style.opacity = '0';
                setTimeout(() => splash?.remove(), 500);
            }, 1500);
            if (user) {
                window.currentUser = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                document.getElementById('display-date').innerText = new Date().toLocaleDateString();
                loadSettings();
                loadInventory();
                loadHistory(); 
            } else {
                window.currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });

        async function loadInventory() {
            if(!window.currentUser) return;
            const q = query(collection(db, "inventory"), where("userId", "==", window.currentUser));
            const querySnapshot = await getDocs(q);
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const item = docSnap.data();
                const id = docSnap.id;
                list.innerHTML += `
                    <div class="bg-slate-50 p-3 rounded-xl border flex justify-between items-center">
                        <div>
                            <p class="font-bold text-xs uppercase">${item.name}</p>
                            <p class="text-[10px] text-slate-400">STOCK: ${item.qty} | $${item.price}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.reponerStock('${id}', '${item.name}')" class="bg-blue-100 text-blue-600 px-2 py-1 rounded-lg text-[10px] font-bold uppercase">‚ûï</button>
                            <button onclick="window.addFromInventory('${id}', '${item.name}', ${item.price}, ${item.qty})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-[10px] font-bold uppercase">A√±adir</button>
                            <button onclick="window.deleteInventoryItem('${id}')" class="text-red-500 text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }
        window.loadInventory = loadInventory;

        window.deleteInventoryItem = async (id) => {
            if(confirm("¬øEliminar del inventario?")) {
                await deleteDoc(doc(db, "inventory", id));
                loadInventory();
            }
        };

        window.reponerStock = async (invId, name) => {
            const extra = prompt(`¬øCu√°ntas unidades de ${name} deseas a√±adir al stock?`, "0");
            if(!extra || isNaN(extra) || Number(extra) <= 0) return;
            try {
                await updateDoc(doc(db, "inventory", invId), {
                    qty: increment(Number(extra))
                });
                alert("Stock actualizado");
                loadInventory();
            } catch(e) { alert("Error al actualizar stock"); }
        };

        window.addToInventory = async () => {
            const name = document.getElementById('inv-name').value;
            const qty = document.getElementById('inv-qty').value;
            const price = document.getElementById('inv-price').value;
            if(!name || !qty || !price) return alert("Completa los datos");
            await addDoc(collection(db, "inventory"), {
                userId: window.currentUser,
                name: name.toUpperCase(),
                qty: Number(qty),
                price: Number(price)
            });
            loadInventory();
            document.getElementById('inv-name').value = '';
            document.getElementById('inv-qty').value = '';
            document.getElementById('inv-price').value = '';
        };

        async function loadHistory() {
            if(!window.currentUser) return;
            const q = query(collection(db, "invoices"), where("userId", "==", window.currentUser));
            const querySnapshot = await getDocs(q);
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const inv = docSnap.data();
                const id = docSnap.id;
                list.innerHTML += `
                    <div class="bg-slate-50 p-4 rounded-2xl border flex justify-between items-center">
                        <div>
                            <p class="font-black text-sm uppercase">${inv.cliente.nombre || 'Sin Nombre'}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${inv.fecha}</p>
                            <p class="text-blue-600 font-black text-xs">$ ${Number(inv.total).toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="window.visualizarFactura('${id}')" class="bg-slate-800 text-white p-2 rounded-xl">üñºÔ∏è</button>
                             <button onclick="window.editarFactura('${id}')" class="bg-blue-100 text-blue-600 p-2 rounded-xl">‚úèÔ∏è</button>
                             <button onclick="window.eliminarFactura('${id}')" class="bg-red-50 text-red-600 p-2 rounded-xl">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
        }
        window.loadHistory = loadHistory;

        window.editarFactura = async (id) => {
            const docSnap = await getDoc(doc(db, "invoices", id));
            if (docSnap.exists()) {
                const inv = docSnap.data();
                window.nuevaFactura(true);
                window.currentEditingInvoiceId = id; 
                
                document.getElementById('display-client-name').innerText = inv.cliente.nombre;
                document.getElementById('display-client-id-text').innerText = inv.cliente.id;
                document.getElementById('in-client-id').value = inv.cliente.id;
                document.getElementById('in-client-name').value = inv.cliente.nombre;
                document.getElementById('in-client-dir').value = inv.cliente.direccion;
                document.getElementById('mo-m2').value = inv.manoObra.metros;
                document.getElementById('mo-price').value = inv.manoObra.precioPorMetro;
                document.getElementById('tasa-cambio').value = inv.tasa;
                
                inv.materiales.forEach(m => {
                    const rowId = Date.now() + Math.random();
                    window.crearFilaMaterial(rowId, m.nombre, m.precio, m.cantidad, !!m.inventoryId, m.inventoryId);
                });
                window.closeModal('modalHistory');
                window.saveAndCalc();
            }
        };

        window.eliminarFactura = async (id) => {
            if(confirm("¬øEliminar factura del historial?")) {
                await deleteDoc(doc(db, "invoices", id));
                loadHistory();
            }
        };

        window.visualizarFactura = async (id) => {
            const docSnap = await getDoc(doc(db, "invoices", id));
            if (docSnap.exists()) {
                const inv = docSnap.data();
                window.editarFactura(id); // Carga los datos para poder renderizarlos
                setTimeout(() => window.enviarAlServidor(), 1000);
            }
        };

        window.guardarFacturaFirebase = async () => {
            const data = window.prepararDatos();
            if(!data.cliente.nombre || data.cliente.nombre === "A√±adir datos del cliente") return alert("Asigna un nombre al cliente");
            try {
                if(window.currentEditingInvoiceId) {
                    await setDoc(doc(db, "invoices", window.currentEditingInvoiceId), {
                        ...data,
                        userId: window.currentUser,
                        fecha: new Date().toLocaleDateString() + " (Editado)"
                    }, { merge: true });
                    alert("Cambios guardados en factura");
                } else {
                    await addDoc(collection(db, "invoices"), {
                        ...data,
                        userId: window.currentUser,
                        fecha: new Date().toLocaleDateString()
                    });
                    alert("Factura guardada con √©xito");
                }
                loadHistory();
            } catch(e) { alert("Error al guardar en la nube"); }
        }

        async function loadSettings() {
            const q = query(collection(db, "settings"), where("userId", "==", window.currentUser));
            const snap = await getDocs(q);
            snap.forEach(doc => {
                const s = doc.data();
                document.getElementById('display-company').innerText = s.nombre;
                document.getElementById('in-comp-name').value = s.nombre;
                if(s.logo) {
                    const img = document.getElementById('logo-img');
                    img.src = s.logo;
                    img.classList.remove('hidden');
                    document.getElementById('logo-txt').classList.add('hidden');
                }
            });
        }

        window.addFromInventory = async (invId, name, price, stockActual) => {
            const cant = prompt(`Cantidad de ${name} (Stock: ${stockActual}):`, "1");
            if(!cant || isNaN(cant) || cant <= 0) return;
            if(Number(cant) > stockActual) return alert("No hay stock suficiente");
            try {
                await updateDoc(doc(db, "inventory", invId), {
                    qty: increment(-Number(cant))
                });
                const rowId = Date.now();
                window.crearFilaMaterial(rowId, name, price, cant, true, invId);
                loadInventory();
                window.closeModal('modalInventory');
                window.saveAndCalc();
            } catch (e) { alert("Error al descontar stock"); }
        };

        window.removeRow = async (id, isInventory, invId, qty) => {
            if(isInventory && invId) {
                const inputQty = document.querySelector(`#row-${id} .item-qty`);
                const cantParaDevolver = inputQty ? inputQty.value : qty;
                await updateDoc(doc(db, "inventory", invId), {
                    qty: increment(Number(cantParaDevolver))
                });
                loadInventory();
            }
            document.getElementById(`row-${id}`).remove();
            window.saveAndCalc();
        };

        window.crearFilaMaterial = (id, name, price, qty, isInv, invId = null) => {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = `${isInv ? 'bg-blue-50 border-blue-100' : 'bg-white border-slate-100'} p-4 rounded-2xl shadow-sm border flex gap-3 items-center animate-slide-up`;
            div.innerHTML = `
                <div class="flex-1">
                    <input type="text" value="${name}" class="w-full text-[10px] font-black uppercase outline-none mb-1 item-name" ${isInv ? 'readonly' : ''}>
                    <div class="flex gap-2">
                        <input type="number" value="${qty}" placeholder="CANT" oninput="window.saveAndCalc()" class="w-16 p-1 ${isInv ? 'bg-white' : 'bg-slate-50'} rounded font-bold text-xs item-qty">
                        <input type="number" value="${price}" placeholder="PRECIO $" oninput="window.saveAndCalc()" class="w-24 p-1 ${isInv ? 'bg-white' : 'bg-slate-50'} rounded font-bold text-xs item-price">
                    </div>
                    ${isInv ? `<input type="hidden" class="inv-id" value="${invId}">` : ''}
                </div>
                <button onclick="window.removeRow('${id}', ${isInv}, '${invId}', ${qty})" class="text-red-400">‚úï</button>
            `;
            container.appendChild(div);
        }

        // EXPOSICI√ìN DE OTRAS FUNCIONES NECESARIAS
        window.addItemRow = (tipo) => {
            const id = Date.now();
            window.crearFilaMaterial(id, "", "", "", false);
        };

        window.saveClientData = () => {
            const id = document.getElementById('in-client-id').value;
            const name = document.getElementById('in-client-name').value;
            if(!name) return alert("M√≠nimo nombre de cliente");
            document.getElementById('display-client-name').innerText = name;
            document.getElementById('display-client-id-text').innerText = id;
            window.closeModal('modalClient');
        };

        window.nuevaFactura = (isEdit = false) => {
            if(!isEdit && !confirm("¬øNueva factura? Se borrar√°n los datos actuales.")) return;
            document.getElementById('items-container').innerHTML = '';
            document.getElementById('mo-m2').value = '';
            document.getElementById('mo-price').value = '';
            document.getElementById('display-client-name').innerText = "A√±adir datos del cliente";
            document.getElementById('display-client-id-text').innerText = "";
            document.getElementById('in-client-id').value = "";
            document.getElementById('in-client-name').value = "";
            document.getElementById('in-client-dir').value = "";
            window.currentEditingInvoiceId = null;
            window.saveAndCalc();
        };

        window.prepararDatos = () => {
            const mats = [];
            document.querySelectorAll('#items-container > div').forEach(row => {
                const invIdInput = row.querySelector('.inv-id');
                mats.push({
                    nombre: row.querySelector('.item-name').value,
                    cantidad: parseFloat(row.querySelector('.item-qty').value) || 0,
                    precio: parseFloat(row.querySelector('.item-price').value) || 0,
                    inventoryId: invIdInput ? invIdInput.value : null
                });
            });
            const totalText = document.getElementById('total-amount').innerText.replace('$ ', '');
            return {
                cliente: {
                    nombre: document.getElementById('display-client-name').innerText,
                    id: document.getElementById('display-client-id-text').innerText,
                    direccion: document.getElementById('in-client-dir').value
                },
                materiales: mats,
                manoObra: {
                    metros: parseFloat(document.getElementById('mo-m2').value) || 0,
                    precioPorMetro: parseFloat(document.getElementById('mo-price').value) || 0
                },
                tasa: parseFloat(document.getElementById('tasa-cambio').value) || 1,
                total: parseFloat(totalText) || 0,
                empresa: document.getElementById('display-company').innerText,
                logo: document.getElementById('logo-img').src
            };
        };

        window.saveAndCalc = () => {
            let totalMateriales = 0;
            document.querySelectorAll('#items-container > div').forEach(row => {
                const q = parseFloat(row.querySelector('.item-qty').value) || 0;
                const p = parseFloat(row.querySelector('.item-price').value) || 0;
                totalMateriales += (q * p);
            });
            const m2 = parseFloat(document.getElementById('mo-m2').value) || 0;
            const moPrice = parseFloat(document.getElementById('mo-price').value) || 0;
            const totalMO = m2 * moPrice;
            const granTotal = totalMateriales + totalMO;
            const tasa = parseFloat(document.getElementById('tasa-cambio').value) || 1;

            document.getElementById('total-amount').innerText = `$ ${granTotal.toFixed(2)}`;
            document.getElementById('total-converted').innerText = `BS ${(granTotal * tasa).toFixed(2)}`;
        };

        // MEJORA: GENERACI√ìN DE IMAGEN LOCAL PARA EVITAR 404
        window.enviarAlServidor = async () => {
            const data = window.prepararDatos();
            const btn = document.getElementById('btn-generate-pdf');
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            // Llenar plantilla de renderizado
            document.getElementById('pro-company').innerText = data.empresa;
            document.getElementById('pro-logo').src = data.logo;
            if(data.logo) document.getElementById('pro-logo').classList.remove('hidden');
            document.getElementById('pro-date').innerText = "Fecha: " + new Date().toLocaleDateString();
            document.getElementById('pro-client-name').innerText = data.cliente.nombre;
            document.getElementById('pro-client-id').innerText = "ID: " + data.cliente.id;
            document.getElementById('pro-client-dir').innerText = data.cliente.direccion || "Sin direcci√≥n";

            const proBody = document.getElementById('pro-items-body');
            proBody.innerHTML = '';
            data.materiales.forEach(m => {
                if(m.nombre) proBody.innerHTML += `<tr><td>${m.cantidad}</td><td class="font-bold uppercase">${m.nombre}</td><td class="text-right">$${m.precio}</td><td class="text-right font-black">$${(m.cantidad*m.precio).toFixed(2)}</td></tr>`;
            });

            if(data.manoObra.metros > 0) {
                document.getElementById('pro-mo-box').classList.remove('hidden');
                document.getElementById('pro-mo-desc').innerText = `Mano de Obra (${data.manoObra.metros} m2)`;
                document.getElementById('pro-mo-total').innerText = `$${(data.manoObra.metros*data.manoObra.precioPorMetro).toFixed(2)}`;
            } else {
                document.getElementById('pro-mo-box').classList.add('hidden');
            }

            document.getElementById('pro-total-usd').innerText = `$ ${data.total.toFixed(2)}`;
            const tasa = parseFloat(document.getElementById('tasa-cambio').value) || 1;
            document.getElementById('pro-total-bs').innerText = `BS ${(data.total * tasa).toFixed(2)}`;

            // Capturar la imagen
            setTimeout(() => {
                html2canvas(document.getElementById('render-invoice'), { scale: 2 }).then(canvas => {
                    const a = document.createElement('a');
                    a.download = `Presupuesto_${data.cliente.nombre.replace(/\s+/g, '_')}.jpg`;
                    a.href = canvas.toDataURL("image/jpeg", 0.9);
                    a.click();
                    btn.disabled = false;
                    btn.innerText = "üñºÔ∏è IMAGEN";
                });
            }, 500);
        };
    </script>
</body>
</html>