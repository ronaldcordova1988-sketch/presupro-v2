//마pp.js
//---CONFIGURACI칍NDERUTAS---
//RECUERDA:En맓ocal,마ntes맋e말niciar:맚askkill/F/IM맕ode.exe
//URL맊onfigurada맗ara맚u마pp만nRender
constㅁPI_URL=망indow.location.hostname==='localhost'맢|망indow.location.hostname==='127.0.0.1'
먝먝먝?''
먝먝먝:'https://presupro-v2.onrender.com';

//---SISTEMAㅁNTI-SLEEP(KEEPㅁLIVE)---
function맙tartAntiSleep()맡
먝먝먝맊onsole.log("Botㅁnti-Sleep마ctivado...");
먝먝먝맙etInterval(async()=>맡
먝먝먝먝먝먝먝맚ry맡
먝먝먝먝먝먝먝먝먝먝먝마wait맍etch(`${API_URL}/ping`);
먝먝먝먝먝먝먝먝먝먝먝맊onsole.log("Ping만nviado맗ara맔antener맙ervidor마ctivo");
먝먝먝먝먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝먝먝먝먝맊onsole.log("Error만n맒eep-alive,맗osiblemente맙ervidorreiniciando");
먝먝먝먝먝먝먝맣
먝먝먝맣,300000);//Cada5맔inutos
}

//---CONFIGURACI칍NINICIAL---
document.addEventListener('DOMContentLoaded',()=>맡
먝먝먝맙tartAntiSleep();

먝먝먝//Splash맙creen
먝먝먝맙etTimeout(()=>맡
먝먝먝먝먝먝먝맊onst맙plash=맋ocument.getElementById('splash');
먝먝먝먝먝먝먝말f(splash)맡
먝먝먝먝먝먝먝먝먝먝먝맙plash.style.opacity='0';
먝먝먝먝먝먝먝먝먝먝먝맙etTimeout(()=>맙plash.remove(),500);
먝먝먝먝먝먝먝맣
먝먝먝맣,2000);
먝먝먝
먝먝먝//Fecha마ctual
먝먝먝맊onst맖pciones=맡맟ear:'numeric',맔onth:'long',맋ay:'numeric'맣;
먝먝먝맊onst맋ateEl=맋ocument.getElementById('display-date');
먝먝먝말f(dateEl)맋ateEl.innerText=맕ewDate().toLocaleDateString('es-ES',맖pciones);

먝먝먝//Cargar마justes많uardados(Nombre맋e만mpresa맟Logo)
먝먝먝맊onst맙avedCompName=맓ocalStorage.getItem('presupro_comp_name');
먝먝먝맊onst맙avedLogo=맓ocalStorage.getItem('presupro_comp_logo');
먝먝먝
먝먝먝말f(savedCompName)맡
먝먝먝먝먝먝먝맊onst맋isplayComp=맋ocument.getElementById('display-company');
먝먝먝먝먝먝먝맊onst말nComp=맋ocument.getElementById('in-comp-name');
먝먝먝먝먝먝먝말f(displayComp)맋isplayComp.innerText=맙avedCompName;
먝먝먝먝먝먝먝말f(inComp)말nComp.value=맙avedCompName;
먝먝먝맣
먝먝먝말f(savedLogo)맡
먝먝먝먝먝먝먝맊onst말mg=맋ocument.getElementById('logo-img');
먝먝먝먝먝먝먝맊onst맚xt=맋ocument.getElementById('logo-txt');
먝먝먝먝먝먝먝말f(img)맡
먝먝먝먝먝먝먝먝먝먝먝말mg.src=맙avedLogo;
먝먝먝먝먝먝먝먝먝먝먝말mg.classList.remove('hidden');
먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝말f(txt)맚xt.classList.add('hidden');
먝먝먝맣
});

//---SISTEMADEㅁUTENTICACI칍N---
window.handleLogin=마sync맍unction()맡
먝먝먝맊onst만mail=맋ocument.getElementById('auth-email').value;
먝먝먝맊onst맗ass=맋ocument.getElementById('auth-pass').value;
먝먝먝맊onst막tn=맋ocument.getElementById('btn-login');

먝먝먝말f(!email맢|!pass)return마lert("Completa맚odos맓os맊ampos");

먝먝먝막tn.innerText="VERIFICANDO...";
먝먝먝막tn.disabled=맚rue;

먝먝먝맚ry맡
먝먝먝먝먝먝먝마wait망indow.signIn(window.auth,만mail,맗ass);
먝먝먝맣맊atch(error)맡
먝먝먝먝먝먝먝맊onsole.error("Error맋eFirebase:",만rror.code);
먝먝먝먝먝먝먝맓et맔sg="Error맋e마cceso:Credenciales말ncorrectas";
먝먝먝먝먝먝먝말f(error.code==='auth/network-request-failed')맔sg="Sin맊onexi칩n마말nternet";
먝먝먝먝먝먝먝마lert(msg);
먝먝먝먝먝먝먝막tn.innerText="Entrar마lSistema";
먝먝먝먝먝먝먝막tn.disabled=맍alse;
먝먝먝맣
}

window.handleLogout=마sync맍unction()맡
먝먝먝말f(confirm("쮺errar맙esi칩n?"))맡
먝먝먝먝먝먝먝마wait망indow.logout(window.auth);
먝먝먝먝먝먝먝맓ocalStorage.clear();
먝먝먝먝먝먝먝맓ocation.reload();
먝먝먝맣
}

//---FUNCIONESDENAVEGACI칍NYMODALES---
window.openModal=맍unction(id)맡
먝먝먝맊onst맔odal=맋ocument.getElementById(id);
먝먝먝말f(!modal)return;
먝먝먝맔odal.classList.remove('hidden');
먝먝먝맔odal.classList.add('flex');
먝먝먝말f(id==='modalInventory')renderInventory();
먝먝먝말f(id==='modalHistory')renderHistory();
}

window.closeModal=맍unction(id)맡
먝먝먝맊onst맔odal=맋ocument.getElementById(id);
먝먝먝말f(!modal)return;
먝먝먝맔odal.classList.add('hidden');
먝먝먝맔odal.classList.remove('flex');
}

//---GESTI칍NDEINVENTARIOFIREBASE(MULTIUSUARIO)---
window.addToInventory=마sync맍unction()맡
먝먝먝말f(!window.currentUser)return;
먝먝먝
먝먝먝맊onst맕ame=맋ocument.getElementById('inv-name').value.toUpperCase().trim();
먝먝먝맊onst맘ty=맗arseFloat(document.getElementById('inv-qty').value)맢|0;
먝먝먝맊onst맗rice=맗arseFloat(document.getElementById('inv-price').value)맢|0;

먝먝먝말f(!name)return마lert("Escribe만l맕ombre맋el맗roducto");

먝먝먝맚ry맡
먝먝먝먝먝먝먝맊onst맡맋oc,맙etDoc,많etDoc맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝먝먝먝먝맊onst맋ocRef=맋oc(window.db,"usuarios",망indow.currentUser,"inventario",맕ame);
먝먝먝먝먝먝먝맊onst맋ocSnap=마wait많etDoc(docRef);

먝먝먝먝먝먝먝말f(docSnap.exists())맡
먝먝먝먝먝먝먝먝먝먝먝맊onst맊urrentData=맋ocSnap.data();
먝먝먝먝먝먝먝먝먝먝먝마wait맙etDoc(docRef,맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맕ombre:맕ame,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊antidad:맊urrentData.cantidad+맘ty,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맗recio:맗rice>0?맗rice:맊urrentData.precio
먝먝먝먝먝먝먝먝먝먝먝맣);
먝먝먝먝먝먝먝맣만lse맡
먝먝먝먝먝먝먝먝먝먝먝마wait맙etDoc(docRef,맡맕ombre:맕ame,맊antidad:맘ty,맗recio:맗rice맣);
먝먝먝먝먝먝먝맣

먝먝먝먝먝먝먝renderInventory();
먝먝먝먝먝먝먝맋ocument.getElementById('inv-name').value="";
먝먝먝먝먝먝먝맋ocument.getElementById('inv-qty').value="";
먝먝먝먝먝먝먝맋ocument.getElementById('inv-price').value="";
먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝맊onsole.error("Error마l많uardar만nFirebase:",만);
먝먝먝맣
}

async맍unctionrenderInventory()맡
먝먝먝말f(!window.currentUser)return;
먝먝먝맊onst맓ist=맋ocument.getElementById('inventory-list');
먝먝먝말f(!list)return;
먝먝먝
먝먝먝맓ist.innerHTML="<p맊lass='text-center맚ext-[10px]'>CARGANDO...</p>";
먝먝먝
먝먝먝맚ry맡
먝먝먝먝먝먝먝맊onst맡맊ollection,많etDocs맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝먝먝먝먝맊onst맘uerySnapshot=마wait많etDocs(collection(window.db,"usuarios",망indow.currentUser,"inventario"));
먝먝먝먝먝먝먝
먝먝먝먝먝먝먝맓ist.innerHTML="";
먝먝먝먝먝먝먝말f(querySnapshot.empty)맡
먝먝먝먝먝먝먝먝먝먝먝맓ist.innerHTML="<p맊lass='text-center맚ext-[10px]맚ext-slate-400'>No맏ay맗roductos만n말nventario.</p>";
먝먝먝먝먝먝먝먝먝먝먝return;
먝먝먝먝먝먝먝맣

먝먝먝먝먝먝먝맘uerySnapshot.forEach((doc)=>맡
먝먝먝먝먝먝먝먝먝먝먝맊onst말tem=맋oc.data();
먝먝먝먝먝먝먝먝먝먝먝맓ist.innerHTML+=`
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<div맊lass="flex맑ustify-between말tems-center막g-slate-50맗-3rounded-xl막order막order-slate-100맔b-2">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<div>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<p맊lass="font-black맚ext-xs맛ppercase">${item.nombre}</p>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<p맊lass="text-[10px]맚ext-slate-500">STOCK:${item.cantidad}맢$${item.precio}</p>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<button맖nclick="selectFromInventory('${item.nombre}')"맊lass="bg-blue-600맚ext-white맚ext-[10px]맗x-3맗y-1rounded-lg맍ont-bold맛ppercase">Seleccionar</button>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝먝먝먝먝`;
먝먝먝먝먝먝먝맣);
먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝맊onsole.error("Error마l맓eer말nventario:",만);
먝먝먝먝먝먝먝맓ist.innerHTML="<p맊lass='text-center맚ext-red-500맚ext-[10px]'>Error마l맊argar맋atos.</p>";
먝먝먝맣
}

window.selectFromInventory=마sync맍unction(nombre)맡
먝먝먝말f(!window.currentUser)return;
먝먝먝맊onst맡맋oc,많etDoc맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝맊onst맋ocRef=맋oc(window.db,"usuarios",망indow.currentUser,"inventario",맕ombre);
먝먝먝맊onst맋ocSnap=마wait많etDoc(docRef);

먝먝먝말f(docSnap.exists())맡
먝먝먝먝먝먝먝맊onst말tem=맋ocSnap.data();
먝먝먝먝먝먝먝마ddItemRow('stock',맡맕ombre:말tem.nombre,맗recio:말tem.precio맣);
먝먝먝먝먝먝먝맊loseModal('modalInventory');
먝먝먝맣
}

//---DESCUENTODESTOCKㅁUTOM츼TICO---
async맍unction맋escontarInventario()맡
먝먝먝말f(!window.currentUser)return;
먝먝먝맊onst맡맋oc,맛pdateDoc,말ncrement,많etDoc맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝맊onst맍ilas=맋ocument.querySelectorAll('.material-row');
먝먝먝
먝먝먝맍or(let맍ila맖f맍ilas)맡
먝먝먝먝먝먝먝말f(fila.dataset.tipo==='stock')맡
먝먝먝먝먝먝먝먝먝먝먝맊onst맕ombre=맍ila.querySelector('.nombre-material').value;
먝먝먝먝먝먝먝먝먝먝먝맊onst맊ant=맗arseFloat(fila.querySelector('.cantidad-material').value)맢|0;
먝먝먝먝먝먝먝먝먝먝먝말f(cant>0)맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊onst맋ocRef=맋oc(window.db,"usuarios",망indow.currentUser,"inventario",맕ombre);
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맚ry맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊onst맋ocSnap=마wait많etDoc(docRef);
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말f(docSnap.exists())맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝마wait맛pdateDoc(docRef,맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊antidad:말ncrement(-cant)
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣);
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊onsole.error("No맙e맗udo맋escontar맙tock맋e:",맕ombre);
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝맣
먝먝먝맣
}

//---GESTI칍NDEMATERIALES---
window.addItemRow=맍unction(tipo='externo',맋ata=맕ull)맡
먝먝먝맊onst맊ontainer=맋ocument.getElementById('items-container');
먝먝먝말f(!container)return;
먝먝먝맊onst맋iv=맋ocument.createElement('div');
먝먝먝
먝먝먝맊onst말sStock=(tipo==='stock');
먝먝먝맊onst막orderColor=말sStock?"border-blue-200막g-blue-50/20":"border-slate-100막g-white";
먝먝먝맊onst막adge=말sStock?"游닍MITIENDA":"游눽COMPRAFUERA";

먝먝먝맋iv.className=`material-row${borderColor}맗-4rounded-2xl맙hadow-sm막order맍lex많ap-3말tems-center마nimate-slide-up맔b-3`;
먝먝먝맋iv.dataset.tipo=맚ipo;
먝먝먝
먝먝먝맋iv.innerHTML=`
먝먝먝먝먝먝먝<div맊lass="flex-1">
먝먝먝먝먝먝먝먝먝먝먝<div맊lass="mb-1">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<span맊lass="text-[7px]맍ont-black맗x-2맗y-0.5rounded-full${isStock?'bg-blue-600맚ext-white':'bg-slate-200맚ext-slate-600'}맛ppercase">${badge}</span>
먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝먝먝먝먝<input맚ype="text"맗laceholder="Producto"
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맜alue="${data?맋ata.nombre:''}"
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝${isStock?'readonly':''}
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊lass="nombre-material맍ont-bold맚ext-sm맛ppercase망-full막g-transparent맖utline-none">
먝먝먝먝먝먝먝먝먝먝먝<div맊lass="flex많ap-4맔t-1">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<input맚ype="number"맗laceholder="Cant"맖ninput="calcTotal()"
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊lass="cantidad-material맚ext-xs맚ext-slate-500망-16막g-slate-50rounded맗x-1맖utline-none">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<input맚ype="number"맗laceholder="Precio$"맖ninput="calcTotal()"
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맜alue="${data?맋ata.precio:''}"
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊lass="precio-material맚ext-xs맚ext-slate-500망-20막g-slate-50rounded맗x-1맖utline-none">
먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝<button맖nclick="this.parentElement.remove();맊alcTotal();"맊lass="text-red-400맗-2맚ext-xl">칑</button>
먝먝먝`;
먝먝먝
먝먝먝맊ontainer.appendChild(div);
먝먝먝맊alcTotal();
}

//---L칍GICADEC츼LCULO---
window.calcTotal=맍unction()맡
먝먝먝맓et맚otalMateriales=0;
먝먝먝맊onst맍ilas=맋ocument.querySelectorAll('.material-row');
먝먝먝맍ilas.forEach(fila=>맡
먝먝먝먝먝먝먝맊onst맊ant=맗arseFloat(fila.querySelector('.cantidad-material').value)맢|0;
먝먝먝먝먝먝먝맊onst맗recio=맗arseFloat(fila.querySelector('.precio-material').value)맢|0;
먝먝먝먝먝먝먝맚otalMateriales+=(cant*맗recio);
먝먝먝맣);

먝먝먝맊onst맔2=맗arseFloat(document.getElementById('mo-m2').value)맢|0;
먝먝먝맊onst맗recioMO=맗arseFloat(document.getElementById('mo-price').value)맢|0;
먝먝먝맊onst맚otalMO=맔2*맗recioMO;

먝먝먝맊onst맚otalGeneral=맚otalMateriales+맚otalMO;
먝먝먝맊onst맚asa=맗arseFloat(document.getElementById('tasa-cambio').value)맢|1;

먝먝먝맊onst맚otalAmtEl=맋ocument.getElementById('total-amount');
먝먝먝맊onst맚otalConvEl=맋ocument.getElementById('total-converted');
먝먝먝
먝먝먝말f(totalAmtEl)맚otalAmtEl.innerText=`$${totalGeneral.toFixed(2)}`;
먝먝먝말f(totalConvEl)맚otalConvEl.innerText=`BS${(totalGeneral*맚asa).toFixed(2)}`;
먝먝먝
먝먝먝return맡맚otalGeneral,맚otalMO,맚otalMateriales,맚asa맣;
}

//---GUARDARYEDITARFACTURAS(MULTIUSUARIO)---
window.guardarFacturaFirebase=마sync맍unction()맡
먝먝먝말f(!window.currentUser)맡
먝먝먝먝먝먝먝마lert("Debes만star맊onectado맗ara많uardar맍acturas.");
먝먝먝먝먝먝먝return;
먝먝먝맣
먝먝먝
먝먝먝맊onst막tn=맋ocument.querySelector('button[onclick="guardarFacturaFirebase()"]');
먝먝먝말f(btn)맡
먝먝먝먝먝먝먝막tn.disabled=맚rue;
먝먝먝먝먝먝먝막tn.innerText="GUARDANDO...";
먝먝먝맣

먝먝먝맊onst맓istaMateriales=[];
먝먝먝맋ocument.querySelectorAll('.material-row').forEach(fila=>맡
먝먝먝먝먝먝먝맓istaMateriales.push({
먝먝먝먝먝먝먝먝먝먝먝맕ombre:맍ila.querySelector('.nombre-material').value,
먝먝먝먝먝먝먝먝먝먝먝맊antidad:맍ila.querySelector('.cantidad-material').value,
먝먝먝먝먝먝먝먝먝먝먝맗recio:맍ila.querySelector('.precio-material').value,
먝먝먝먝먝먝먝먝먝먝먝맚ipo:맍ila.dataset.tipo
먝먝먝먝먝먝먝맣);
먝먝먝맣);

먝먝먝맊onst맍actura=맡
먝먝먝먝먝먝먝맍echa:맕ewDate().getTime(),
먝먝먝먝먝먝먝맊liente:맋ocument.getElementById('display-client-name').innerText,
먝먝먝먝먝먝먝맊lienteId:맋ocument.getElementById('in-client-id').value,
먝먝먝먝먝먝먝맔ateriales:맓istaMateriales,
먝먝먝먝먝먝먝맔2:맋ocument.getElementById('mo-m2').value,
먝먝먝먝먝먝먝맗recioMO:맋ocument.getElementById('mo-price').value,
먝먝먝먝먝먝먝맚otal:맋ocument.getElementById('total-amount').innerText
먝먝먝맣;

먝먝먝맚ry맡
먝먝먝먝먝먝먝맊onst맡맊ollection,마ddDoc맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝먝먝먝먝마wait마ddDoc(collection(window.db,"usuarios",망indow.currentUser,"facturas"),맍actura);
먝먝먝먝먝먝먝마lert("Factura많uardada만n맚u맏istorial");
먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝마lert("Error마l많uardar맍actura");
먝먝먝맣맍inally맡
먝먝먝먝먝먝먝말f(btn)맡
먝먝먝먝먝먝먝먝먝먝먝막tn.disabled=맍alse;
먝먝먝먝먝먝먝먝먝먝먝막tn.innerHTML="<span>游</span>GUARDAR";
먝먝먝먝먝먝먝맣
먝먝먝맣
}

async맍unctionrenderHistory()맡
먝먝먝말f(!window.currentUser)return;
먝먝먝맊onst맓ist=맋ocument.getElementById('history-list');
먝먝먝말f(!list)return;

먝먝먝맓ist.innerHTML="<p맊lass='text-center맚ext-[10px]'>CARGANDOHISTORIAL...</p>";

먝먝먝맚ry맡
먝먝먝먝먝먝먝맊onst맡맊ollection,많etDocs,맘uery,맖rderBy맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝먝먝먝먝맊onst맘=맘uery(collection(window.db,"usuarios",망indow.currentUser,"facturas"),맖rderBy("fecha","desc"));
먝먝먝먝먝먝먝맊onst맙nap=마wait많etDocs(q);
먝먝먝먝먝먝먝
먝먝먝먝먝먝먝맓ist.innerHTML="";
먝먝먝먝먝먝먝말f(snap.empty)맡
먝먝먝먝먝먝먝먝먝먝먝맓ist.innerHTML="<p맊lass='text-center맚ext-[10px]맚ext-slate-400'>No맏ay맍acturas많uardadas.</p>";
먝먝먝먝먝먝먝먝먝먝먝return;
먝먝먝먝먝먝먝맣

먝먝먝먝먝먝먝맙nap.forEach(docSnap=>맡
먝먝먝먝먝먝먝먝먝먝먝맊onst맍=맋ocSnap.data();
먝먝먝먝먝먝먝먝먝먝먝맊onst맋=맕ewDate(f.fecha).toLocaleDateString();
먝먝먝먝먝먝먝먝먝먝먝맓ist.innerHTML+=`
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<div맊lass="bg-slate-50맗-4rounded-2xl막order맔b-2맍lex맑ustify-between말tems-start">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<div맊lass="flex-1">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<p맊lass="text-[10px]맍ont-bold맚ext-blue-600">${d}</p>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<p맊lass="font-black맚ext-xs맛ppercase">${f.cliente}</p>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<p맊lass="text-xs맚ext-slate-500">${f.total}</p>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<div맊lass="flex많ap-2맔t-2">
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<button맖nclick="cargarFactura('${docSnap.id}')"맊lass="bg-slate-800맚ext-white맚ext-[9px]맗x-2맗y-1rounded">EDITAR</button>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝<button맖nclick="borrarFactura('${docSnap.id}')"맊lass="bg-red-500맚ext-white맚ext-[9px]맗x-2맗y-1rounded">BORRAR</button>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝</div>
먝먝먝먝먝먝먝먝먝먝먝`;
먝먝먝먝먝먝먝맣);
먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝맊onsole.error(e);
먝먝먝먝먝먝먝맓ist.innerHTML="<p맊lass='text-center맚ext-red-500맚ext-[10px]'>Error마l맊onectar맊on만l맏istorial.</p>";
먝먝먝맣
}

window.borrarFactura=마sync맍unction(id)맡
먝먝먝말f(!confirm("쯉eguro맘ue맋eseas만liminar만sta맍actura?"))return;
먝먝먝말f(!window.currentUser)return;
먝먝먝
먝먝먝맚ry맡
먝먝먝먝먝먝먝맊onst맡맋oc,맋eleteDoc맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝먝먝먝먝마wait맋eleteDoc(doc(window.db,"usuarios",망indow.currentUser,"facturas",말d));
먝먝먝먝먝먝먝마lert("Factura만liminada");
먝먝먝먝먝먝먝renderHistory();
먝먝먝맣맊atch(e)맡
먝먝먝먝먝먝먝마lert("No맙e맗udo만liminar");
먝먝먝맣
}

window.cargarFactura=마sync맍unction(id)맡
먝먝먝말f(!window.currentUser)return;
먝먝먝맊onst맡맋oc,많etDoc맣=마wait말mport("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
먝먝먝맊onst맙nap=마wait많etDoc(doc(window.db,"usuarios",망indow.currentUser,"facturas",말d));
먝먝먝말f(snap.exists())맡
먝먝먝먝먝먝먝맊onst맍=맙nap.data();
먝먝먝먝먝먝먝망indow.nuevaFactura(false);
먝먝먝먝먝먝먝맋ocument.getElementById('display-client-name').innerText=맍.cliente;
먝먝먝먝먝먝먝맋ocument.getElementById('in-client-id').value=맍.clienteId;
먝먝먝먝먝먝먝맋ocument.getElementById('mo-m2').value=맍.m2;
먝먝먝먝먝먝먝맋ocument.getElementById('mo-price').value=맍.precioMO;
먝먝먝먝먝먝먝맍.materiales.forEach(m=>맡
먝먝먝먝먝먝먝먝먝먝먝망indow.addItemRow(m.tipo,맡맕ombre:맔.nombre,맗recio:맔.precio맣);
먝먝먝먝먝먝먝먝먝먝먝맊onst맍ilas=맋ocument.querySelectorAll('#items-container.material-row');
먝먝먝먝먝먝먝먝먝먝먝맊onst맛ltimaFila=맍ilas[filas.length-1];
먝먝먝먝먝먝먝먝먝먝먝맛ltimaFila.querySelector('.cantidad-material').value=맔.cantidad;
먝먝먝먝먝먝먝맣);
먝먝먝먝먝먝먝망indow.calcTotal();
먝먝먝먝먝먝먝망indow.closeModal('modalHistory');
먝먝먝맣
}

window.nuevaFactura=맍unction(preguntar=맚rue)맡
먝먝먝말f(preguntar&&!confirm("쯃impiar맚odo맗ara맛na맕ueva맍actura?"))return;
먝먝먝맊onst맊ontainer=맋ocument.getElementById('items-container');
먝먝먝말f(container)맊ontainer.innerHTML="";
먝먝먝맋ocument.getElementById('mo-m2').value="";
먝먝먝맋ocument.getElementById('mo-price').value="";
먝먝먝맋ocument.getElementById('in-client-name').value="";
먝먝먝맋ocument.getElementById('in-client-id').value="";
먝먝먝맋ocument.getElementById('display-client-name').innerText="Tocar맗ara마침adir맋atos";
먝먝먝망indow.calcTotal();
}

//---ENV칈OㅁLSERVIDOR---
window.enviarAlServidor=마sync맍unction()맡
먝먝먝맊onst막tn=맋ocument.querySelector('button[onclick="enviarAlServidor()"]');
먝먝먝말f(btn)맡
먝먝먝먝먝먝먝막tn.disabled=맚rue;
먝먝먝먝먝먝먝막tn.innerText="GENERANDO...";
먝먝먝맣

먝먝먝맚ry맡
먝먝먝먝먝먝먝맊onst맓istaMateriales=[];
먝먝먝먝먝먝먝맋ocument.querySelectorAll('.material-row').forEach(fila=>맡
먝먝먝먝먝먝먝먝먝먝먝맓istaMateriales.push({
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맕ombre:맍ila.querySelector('.nombre-material').value맢|"Producto",
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊antidad:맍ila.querySelector('.cantidad-material').value맢|0,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맗recio:맍ila.querySelector('.precio-material').value맢|0,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맙ubtotal:(parseFloat(fila.querySelector('.cantidad-material').value)맢|0)*(parseFloat(fila.querySelector('.precio-material').value)맢|0)
먝먝먝먝먝먝먝먝먝먝먝맣);
먝먝먝먝먝먝먝맣);

먝먝먝먝먝먝먝맊onst맚otales=망indow.calcTotal();

먝먝먝먝먝먝먝맊onst맋atos=맡
먝먝먝먝먝먝먝먝먝먝먝맊liente:맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맕ombre:맋ocument.getElementById('display-client-name').innerText,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말d:맋ocument.getElementById('in-client-id').value맢|"N/A"
먝먝먝먝먝먝먝먝먝먝먝맣,
먝먝먝먝먝먝먝먝먝먝먝만mpresa:맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맕ombre:맋ocument.getElementById('display-company').innerText,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맓ogo:맋ocument.getElementById('logo-img').src
먝먝먝먝먝먝먝먝먝먝먝맣,
먝먝먝먝먝먝먝먝먝먝먝맔ateriales:맓istaMateriales,
먝먝먝먝먝먝먝먝먝먝먝맔anoObra:맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맔etros:맋ocument.getElementById('mo-m2').value맢|0,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맗recioPorMetro:맋ocument.getElementById('mo-price').value맢|0,
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맚otalMO:맚otales.totalMO
먝먝먝먝먝먝먝먝먝먝먝맣,
먝먝먝먝먝먝먝먝먝먝먝맚otalGeneral:맚otales.totalGeneral,
먝먝먝먝먝먝먝먝먝먝먝맚asa:맚otales.tasa
먝먝먝먝먝먝먝맣;

먝먝먝먝먝먝먝맊onstresponse=마wait맍etch(`${API_URL}/generar-presupuesto`,맡
먝먝먝먝먝먝먝먝먝먝먝맔ethod:'POST',
먝먝먝먝먝먝먝먝먝먝먝맏eaders:맡'Content-Type':'application/json'맣,
먝먝먝먝먝먝먝먝먝먝먝막ody:JSON.stringify(datos)
먝먝먝먝먝먝먝맣);

먝먝먝먝먝먝먝말f(response.ok)맡
먝먝먝먝먝먝먝먝먝먝먝//Descontar말nventario맙olo맙i만l맙ervidorrespondi칩막ien
먝먝먝먝먝먝먝먝먝먝먝마wait맋escontarInventario();
먝먝먝먝먝먝먝먝먝먝먝
먝먝먝먝먝먝먝먝먝먝먝맊onst맏tml=마waitresponse.text();
먝먝먝먝먝먝먝먝먝먝먝맊onst망in=망indow.open('','_blank');
먝먝먝먝먝먝먝먝먝먝먝말f(win)맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝망in.document.write(html);
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝망in.document.close();
먝먝먝먝먝먝먝먝먝먝먝맣만lse맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝마lert("Ventana만mergente막loqueada.Por맍avor,맗ermite맓as맜entanas만mergentes맗ara맜er맚u맗resupuesto.");
먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝맣만lse맡
먝먝먝먝먝먝먝먝먝먝먝맊onst만rrorMsg=마waitresponse.json().catch(()=>({}));
먝먝먝먝먝먝먝먝먝먝먝마lert("Error맋el맙ervidor:"+(errorMsg.error맢|"No맙e맗udo많enerar만l맗resupuesto."));
먝먝먝먝먝먝먝맣
먝먝먝맣맊atch(error)맡
먝먝먝먝먝먝먝맊onsole.error("Error만n만nv칤o:",만rror);
먝먝먝먝먝먝먝마lert("Error맋e맊onexi칩n.Verifica맙i만l맙ervidor만nRender만st치마ctivo.");
먝먝먝맣맍inally맡
먝먝먝먝먝먝먝말f(btn)맡
먝먝먝먝먝먝먝먝먝먝먝막tn.disabled=맍alse;
먝먝먝먝먝먝먝먝먝먝먝막tn.innerHTML="<span>游닌</span>PDF";
먝먝먝먝먝먝먝맣
먝먝먝맣
}

//---PERSONALIZACI칍N---
window.saveClientData=맍unction()맡
먝먝먝맊onst맕ombre=맋ocument.getElementById('in-client-name').value;
먝먝먝맊onst말d=맋ocument.getElementById('in-client-id').value;
먝먝먝말f(nombre)맡
먝먝먝먝먝먝먝맋ocument.getElementById('display-client-name').innerText=맕ombre.toUpperCase();
먝먝먝맣
먝먝먝망indow.closeModal('modalClient');
}

window.saveSettings=맍unction()맡
먝먝먝맊onst맕ame=맋ocument.getElementById('in-comp-name').value;
먝먝먝말f(name)맡
먝먝먝먝먝먝먝맊onst맛pperName=맕ame.toUpperCase();
먝먝먝먝먝먝먝맋ocument.getElementById('display-company').innerText=맛pperName;
먝먝먝먝먝먝먝맓ocalStorage.setItem('presupro_comp_name',맛pperName);
먝먝먝맣
먝먝먝망indow.closeModal('modalSettings');
}

window.previewLogo=맍unction(input)맡
먝먝먝말f(input.files&&말nput.files[0])맡
먝먝먝먝먝먝먝맊onstreader=맕ewFileReader();
먝먝먝먝먝먝먝reader.onload=맍unction(e)맡
먝먝먝먝먝먝먝먝먝먝먝맊onst말mg=맋ocument.getElementById('logo-img');
먝먝먝먝먝먝먝먝먝먝먝맊onst맚xt=맋ocument.getElementById('logo-txt');
먝먝먝먝먝먝먝먝먝먝먝맊onst막ase64Logo=만.target.result;
먝먝먝먝먝먝먝먝먝먝먝말f(img)맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말mg.src=막ase64Logo;
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말mg.classList.remove('hidden');
먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝먝먝먝먝말f(txt)맚xt.classList.add('hidden');
먝먝먝먝먝먝먝먝먝먝먝맓ocalStorage.setItem('presupro_comp_logo',막ase64Logo);
먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝reader.readAsDataURL(input.files[0]);
먝먝먝맣
}

//---REGISTRODESERVICEWORKER(MEJORADO)---
if('serviceWorker'말n맕avigator)맡
먝먝먝망indow.addEventListener('load',()=>맡
먝먝먝먝먝먝먝맕avigator.serviceWorker.register('/sw.js')
먝먝먝먝먝먝먝먝먝먝먝.then(registration=>맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊onsole.log('SWregistrado맊on먞뼞ito:',registration.scope);
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝//MEJORA:Detecci칩n맋e마ctualizaciones만n맙egundo맗lano
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝registration.onupdatefound=()=>맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊onst말nstallingWorker=registration.installing;
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말nstallingWorker.onstatechange=()=>맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말f(installingWorker.state==='installed')맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말f(navigator.serviceWorker.controller)맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맊onsole.log('Nueva맜ersi칩n맋isponible.Por맍avorrecargue.');
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝말f(confirm("Nueva마ctualizaci칩n맓ista.먝Recargar마hora?"))맡
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맓ocation.reload();
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣;
먝먝먝먝먝먝먝먝먝먝먝먝먝먝먝맣;
먝먝먝먝먝먝먝먝먝먝먝맣)
먝먝먝먝먝먝먝먝먝먝먝.catch(err=>맊onsole.error('Fallo마lregistrarSW:',만rr));
먝먝먝맣);
}

//---FIX:DEFINICI칍NGLOBALDESAVEANDCALC---
window.saveAndCalc=맍unction()맡
먝먝먝망indow.calcTotal();
};