<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PresuPro APK</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            /* Evita el scroll el谩stico en iOS y asegura que ocupe toda la pantalla */
            overscroll-behavior-y: contain;
        }
        input, textarea {
            user-select: text;
        }
        /* Animaci贸n suave para modales */
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        /* Ocultar barra de scroll pero mantener funcionalidad */
        ::-webkit-scrollbar {
            display: none;
        }
        /* Mejora visual para botones deshabilitados */
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden antialiased">

    <div id="splash" class="fixed inset-0 bg-blue-600 z-[100] flex items-center justify-center transition-opacity duration-500">
        <div class="text-white text-center">
            <h1 class="text-4xl font-black italic tracking-tighter uppercase">Presu<span class="text-blue-200">Pro</span></h1>
            <div class="mt-4 animate-spin h-6 w-6 border-4 border-white border-t-transparent rounded-full mx-auto"></div>
        </div>
    </div>

    <div id="auth-screen" class="fixed inset-0 bg-slate-900 z-[90] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="text-3xl mb-2"></div>
                <h2 class="text-2xl font-black text-slate-800 uppercase italic leading-none">Acceso<br><span class="text-blue-600">Restringido</span></h2>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-2">Ingresa tus credenciales</p>
            </div>
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Correo Electr贸nico</label>
                    <input type="email" id="auth-email" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Contrase帽a</label>
                    <input type="password" id="auth-pass" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm shadow-lg active:scale-95 transition-all">
                    Entrar al Sistema
                </button>
            </form>
            <p class="text-center text-[9px] text-slate-400 mt-6 uppercase font-bold tracking-tighter">Software Protegido por Licencia PresuPro</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 no-print">
            <button onclick="nuevaFactura()" class="flex flex-col items-center text-blue-600">
                <span class="text-xl"></span>
                <span class="text-[10px] font-bold uppercase">Nueva</span>
            </button>
            <button onclick="openModal('modalInventory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl"></span>
                <span class="text-[10px] font-bold uppercase">Inventario</span>
            </button>
            <button onclick="openModal('modalHistory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl"></span>
                <span class="text-[10px] font-bold uppercase">Historial</span>
            </button>
            <button onclick="openModal('modalSettings')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">锔</span>
                <span class="text-[10px] font-bold uppercase">Ajustes</span>
            </button>
        </nav>

        <main id="view-calc" class="p-4 pb-24 max-w-xl mx-auto min-h-screen">
            <header id="header-design" class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-blue-600 mb-6 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-2xl bg-slate-100 flex items-center justify-center overflow-hidden border">
                        <img id="logo-img" src="" class="hidden w-full h-full object-contain">
                        <span id="logo-txt" class="text-[10px] font-bold text-slate-400">LOGO</span>
                    </div>
                    <div>
                        <h2 id="display-company" class="text-xl font-black uppercase leading-none text-blue-600">Mi Empresa</h2>
                        <p id="display-date" class="text-[10px] font-mono text-slate-400 mt-1 uppercase"></p>
                    </div>
                </div>
            </header>

            <button onclick="openModal('modalClient')" class="w-full bg-white border-2 border-dashed border-slate-200 p-4 rounded-2xl mb-6 flex justify-between items-center active:scale-95 transition-transform">
                <div class="text-left">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Cliente:</p>
                    <p id="display-client-name" class="font-bold text-slate-700 uppercase italic">Tocar para a帽adir datos</p>
                    <p id="display-client-id-text" class="text-[9px] text-slate-400 uppercase"></p>
                </div>
                <span class="text-blue-500 text-xl"></span>
            </button>

            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2">Lista de Materiales</h3>
            <div id="items-container" class="space-y-3"></div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="addItemRow('externo')" class="py-4 bg-white border-2 border-slate-300 border-dashed rounded-2xl text-slate-600 font-bold text-[10px] uppercase hover:bg-slate-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg"></span> Compra Externa
                </button>
                <button onclick="openModal('modalInventory')" class="py-4 bg-white border-2 border-blue-600 border-dashed rounded-2xl text-blue-600 font-bold text-[10px] uppercase hover:bg-blue-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg"></span> Mi Inventario
                </button>
            </div>

            <div class="mt-8 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4">C谩lculo de Mano de Obra</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">METROS CUADRADOS (m2)</label>
                        <input type="number" id="mo-m2" oninput="calcTotal()" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">PRECIO POR m2 ($)</label>
                        <input type="number" id="mo-price" oninput="calcTotal()" placeholder="0.00" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-slate-900 text-white p-6 rounded-[2rem] shadow-2xl">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total General</p>
                        <h2 id="total-amount" class="text-3xl font-black text-white">$ 0.00</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Tasa del d铆a</p>
                        <input type="number" id="tasa-cambio" value="60" oninput="calcTotal()" class="bg-transparent text-right font-black text-xl w-20 outline-none border-b border-blue-500/30">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="enviarAlServidor()" class="py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span></span> PDF
                    </button>
                    <button id="btn-save-invoice" onclick="guardarFacturaFirebase()" class="py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span></span> GUARDAR
                    </button>
                </div>

                <div class="pt-4 border-t border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase italic">Monto en BS:</span>
                    <span id="total-converted" class="text-xl font-black text-blue-400">BS 0.00</span>
                </div>
            </div>
        </main>
    </div>

    <div id="modalClient" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up">
            <h3 class="font-black uppercase text-slate-800 mb-4">Informaci贸n del Cliente</h3>
            <div class="space-y-3">
                <input type="text" id="in-client-id" placeholder="C茅dula / ID" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-name" placeholder="Nombre Completo" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-dir" placeholder="Direcci贸n" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <button onclick="saveClientData()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm mt-2">Listo</button>
            </div>
        </div>
    </div>

    <div id="modalInventory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Mi Inventario</h3>
                <button onclick="closeModal('modalInventory')" class="text-2xl">&times;</button>
            </div>
            <div class="bg-slate-100 p-4 rounded-2xl mb-4 space-y-2">
                <input type="text" id="inv-name" placeholder="Nombre Producto" class="w-full p-2 rounded-lg text-xs uppercase font-bold outline-none">
                <div class="flex gap-2">
                    <input type="number" id="inv-qty" placeholder="Stock" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                    <input type="number" id="inv-price" placeholder="Precio $" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                </div>
                <button id="btn-add-inv" onclick="addToInventory()" class="w-full bg-slate-800 text-white text-[10px] font-bold py-2 rounded-lg uppercase">+ Guardar</button>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="modalHistory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Historial Facturas</h3>
                <button onclick="closeModal('modalHistory')" class="text-2xl">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="modalSettings" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black uppercase">Configuraci贸n</h3>
                <button onclick="closeModal('modalSettings')" class="text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <input type="text" id="in-comp-name" placeholder="Nombre Empresa" class="w-full p-4 bg-slate-50 rounded-2xl border font-black uppercase text-center">
                <button onclick="document.getElementById('logo-input').click()" class="w-full py-3 border-2 border-dashed rounded-2xl font-bold text-slate-400 text-[10px]">CAMBIAR LOGO</button>
                <input type="file" id="logo-input" class="hidden" onchange="previewLogo(this)">
                <button id="btn-save-settings" onclick="saveSettings()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase">Guardar Cambios</button>
                <hr class="my-2">
                <button onclick="handleLogout()" class="w-full bg-red-100 text-red-600 font-black py-4 rounded-2xl uppercase text-[10px]">Cerrar Sesi贸n</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTfukrycpMrtYZ6vuF06knIxi4-g8TLLs",
            authDomain: "presuproapp.firebaseapp.com",
            projectId: "presuproapp",
            storageBucket: "presuproapp.firebasestorage.app",
            messagingSenderId: "56089233501",
            appId: "1:56089233501:web:363348f4daf2b6bb9825b4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Persistencia para que funcione sin internet (clave para APK)
        enableIndexedDbPersistence(db).catch((err) => {
            console.log("Persistencia fall贸 o ya est谩 activa");
        });

        window.db = db;
        window.auth = auth;
        window.signIn = signInWithEmailAndPassword;
        window.logout = signOut;

        onAuthStateChanged(auth, (user) => {
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const splash = document.getElementById('splash');

            // Quitar splash screen tras una peque帽a espera para ver el logo
            setTimeout(() => {
                if (splash) splash.style.opacity = '0';
                setTimeout(() => splash ? splash.remove() : null, 500);
            }, 1500);

            if (user) {
                window.currentUser = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                if (window.renderInventory) window.renderInventory();
                // Mejora: cargar ajustes al iniciar sesi贸n
                if (window.loadSettings) window.loadSettings();
            } else {
                window.currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
    </script>
    
    <script src="app.js"></script>

    <script>
        // Registro del Service Worker corregido para evitar errores en el instalador de Android (Ruta ./ absoluta)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js', { scope: './' })
                    .then(reg => console.log('Service Worker registrado correctamente'))
                    .catch(err => console.error('Error al registrar Service Worker:', err));
            });
        }

        // Funci贸n global para manejar el login desde el bot贸n
        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('btn-login');
            
            if(!email || !pass) return alert("Por favor rellena los campos");
            
            btn.innerText = "Cargando...";
            btn.disabled = true;
            
            try {
                await window.signIn(window.auth, email, pass);
            } catch (error) {
                let msg = "Error de acceso";
                if(error.code === 'auth/wrong-password') msg = "Contrase帽a incorrecta";
                if(error.code === 'auth/user-not-found') msg = "Usuario no registrado";
                alert(msg + ": " + error.message);
                btn.innerText = "Entrar al Sistema";
                btn.disabled = false;
            }
        }

        // Manejador para el cierre de sesi贸n con confirmaci贸n
        function handleLogout() {
            if(confirm("驴Est谩s seguro de que deseas cerrar sesi贸n?")) {
                window.logout(window.auth);
            }
        }
    </script>
</body>
</html>