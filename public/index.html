<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PresuPro v2</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&family=Playfair+Display:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            overscroll-behavior-y: contain;
        }
        input, textarea {
            user-select: text;
        }
        .animate-slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        ::-webkit-scrollbar {
            display: none;
        }
        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        /* Estilo para impresi贸n b谩sica */
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 overflow-x-hidden antialiased">

    <div id="splash" class="fixed inset-0 bg-blue-600 z-[100] flex items-center justify-center transition-opacity duration-500">
        <div class="text-white text-center">
            <h1 class="text-4xl font-black italic tracking-tighter uppercase">Presu<span class="text-blue-200">Pro</span></h1>
            <div class="mt-4 animate-spin h-6 w-6 border-4 border-white border-t-transparent rounded-full mx-auto"></div>
        </div>
    </div>

    <div id="auth-screen" class="fixed inset-0 bg-slate-900 z-[90] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="text-3xl mb-2"></div>
                <h2 class="text-2xl font-black text-slate-800 uppercase italic leading-none">Acceso<br><span class="text-blue-600">Restringido</span></h2>
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mt-2">Ingresa tus credenciales</p>
            </div>
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Correo Electr贸nico</label>
                    <input type="email" id="auth-email" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Contrase帽a</label>
                    <input type="password" id="auth-pass" required class="w-full p-4 bg-slate-100 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-500 font-bold text-sm">
                </div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm shadow-lg active:scale-95 transition-all">
                    Entrar al Sistema
                </button>
            </form>
            <p class="text-center text-[9px] text-slate-400 mt-6 uppercase font-bold tracking-tighter">Software Protegido por Licencia PresuPro</p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="fixed bottom-0 shrink-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around items-center h-16 z-50 no-print">
            <button onclick="nuevaFactura()" class="flex flex-col items-center text-blue-600">
                <span class="text-xl"></span>
                <span class="text-[10px] font-bold uppercase">Nueva</span>
            </button>
            <button onclick="openModal('modalInventory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl"></span>
                <span class="text-[10px] font-bold uppercase">Inventario</span>
            </button>
            <button onclick="openModal('modalHistory')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl"></span>
                <span class="text-[10px] font-bold uppercase">Historial</span>
            </button>
            <button onclick="openModal('modalSettings')" class="flex flex-col items-center text-slate-400">
                <span class="text-xl">锔</span>
                <span class="text-[10px] font-bold uppercase">Ajustes</span>
            </button>
        </nav>

        <main id="view-calc" class="p-4 pb-24 max-w-xl mx-auto min-h-screen">
            <header id="header-design" class="bg-white p-6 rounded-3xl shadow-sm border-l-8 border-blue-600 mb-6 transition-all duration-300">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-2xl bg-slate-100 flex items-center justify-center overflow-hidden border">
                        <img id="logo-img" src="" class="hidden w-full h-full object-contain">
                        <span id="logo-txt" class="text-[10px] font-bold text-slate-400 text-center px-1">LOGO</span>
                    </div>
                    <div>
                        <h2 id="display-company" class="text-xl font-black uppercase leading-none text-blue-600">Mi Empresa</h2>
                        <p id="display-date" class="text-[10px] font-mono text-slate-400 mt-1 uppercase"></p>
                    </div>
                </div>
            </header>

            <button onclick="openModal('modalClient')" class="w-full bg-white border-2 border-dashed border-slate-200 p-4 rounded-2xl mb-6 flex justify-between items-center active:scale-95 transition-transform">
                <div class="text-left">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Cliente:</p>
                    <p id="display-client-name" class="font-bold text-slate-700 uppercase italic text-sm">A帽adir datos del cliente</p>
                    <p id="display-client-id-text" class="text-[9px] text-slate-400 uppercase"></p>
                </div>
                <span class="text-blue-500 text-xl"></span>
            </button>

            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2">Lista de Materiales</h3>
            <div id="items-container" class="space-y-3">
                </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="addItemRow('externo')" class="py-4 bg-white border-2 border-slate-300 border-dashed rounded-2xl text-slate-600 font-bold text-[10px] uppercase hover:bg-slate-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg"></span> Compra Externa
                </button>
                <button onclick="openModal('modalInventory')" class="py-4 bg-white border-2 border-blue-600 border-dashed rounded-2xl text-blue-600 font-bold text-[10px] uppercase hover:bg-blue-50 active:scale-95 transition-all flex flex-col items-center gap-1">
                    <span class="text-lg"></span> Mi Inventario
                </button>
            </div>

            <div class="mt-8 bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4">C谩lculo de Mano de Obra</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">METROS CUADRADOS (m2)</label>
                        <input type="number" id="mo-m2" oninput="saveAndCalc()" placeholder="0" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-slate-400 ml-1">PRECIO POR m2 ($)</label>
                        <input type="number" id="mo-price" oninput="saveAndCalc()" placeholder="0.00" class="w-full p-3 bg-slate-50 rounded-xl font-bold border-none outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-slate-900 text-white p-6 rounded-[2rem] shadow-2xl">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total General</p>
                        <h2 id="total-amount" class="text-3xl font-black text-white">$ 0.00</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-blue-400 uppercase">Tasa del d铆a</p>
                        <input type="number" id="tasa-cambio" value="60" oninput="saveAndCalc()" class="bg-transparent text-right font-black text-xl w-20 outline-none border-b border-blue-500/30">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button id="btn-generate-pdf" onclick="enviarAlServidor()" class="py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span></span> PDF
                    </button>
                    <button id="btn-save-invoice" onclick="guardarFacturaFirebase()" class="py-4 bg-emerald-600 hover:bg-emerald-700 text-white rounded-2xl font-black uppercase text-[10px] transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2">
                        <span></span> GUARDAR
                    </button>
                </div>

                <div class="pt-4 border-t border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase italic">Monto en BS:</span>
                    <span id="total-converted" class="text-xl font-black text-blue-400">BS 0.00</span>
                </div>
            </div>

            <footer class="mt-12 text-center pb-10">
                <p class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em] mb-1">PresuPro v2.0</p>
                <p class="text-[9px] font-bold text-blue-400/50 uppercase">Conexi贸n con Servidor Render Activa</p>
            </footer>
        </main>
    </div>

    <div id="modalClient" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up">
            <h3 class="font-black uppercase text-slate-800 mb-4">Informaci贸n del Cliente</h3>
            <div class="space-y-3">
                <input type="text" id="in-client-id" placeholder="C茅dula / ID" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-name" placeholder="Nombre Completo" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <input type="text" id="in-client-dir" placeholder="Direcci贸n" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                <button onclick="saveClientData()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm mt-2">Listo</button>
                <button onclick="closeModal('modalClient')" class="w-full text-slate-400 font-bold text-[10px] uppercase">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalInventory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Mi Inventario</h3>
                <button onclick="closeModal('modalInventory')" class="text-2xl">&times;</button>
            </div>
            <div class="bg-slate-100 p-4 rounded-2xl mb-4 space-y-2">
                <input type="text" id="inv-name" placeholder="Nombre Producto" class="w-full p-2 rounded-lg text-xs uppercase font-bold outline-none">
                <div class="flex gap-2">
                    <input type="number" id="inv-qty" placeholder="Stock" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                    <input type="number" id="inv-price" placeholder="Precio $" class="w-1/2 p-2 rounded-lg text-xs outline-none">
                </div>
                <button id="btn-add-inv" onclick="addToInventory()" class="w-full bg-slate-800 text-white text-[10px] font-bold py-2 rounded-lg uppercase">+ Guardar en Stock</button>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2"></div>
        </div>
    </div>

    <div id="modalHistory" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black uppercase">Historial de Facturas</h3>
                <button onclick="closeModal('modalHistory')" class="text-2xl">&times;</button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto space-y-3"></div>
        </div>
    </div>

    <div id="modalSettings" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl animate-slide-up">
            <h3 class="font-black uppercase mb-4">Configuraci贸n</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Nombre de Empresa</label>
                    <input type="text" id="in-comp-name" class="w-full p-4 bg-slate-50 rounded-2xl outline-none border font-bold text-sm">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Logo de Empresa</label>
                    <input type="file" id="in-comp-logo" onchange="previewLogo(this)" class="w-full text-xs mt-1" accept="image/*">
                </div>
                <button onclick="saveSettings()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl uppercase text-sm">Guardar Cambios</button>
                <button onclick="handleLogout()" class="w-full bg-red-50 text-red-600 font-black py-4 rounded-2xl uppercase text-sm mt-4">Cerrar Sesi贸n</button>
                <button onclick="closeModal('modalSettings')" class="w-full text-slate-400 font-bold text-[10px] uppercase">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBTfukrycpMrtYZ6vuF06knIxi4-g8TLLs",
            authDomain: "presuproapp.firebaseapp.com",
            projectId: "presuproapp",
            storageBucket: "presuproapp.firebasestorage.app",
            messagingSenderId: "56089233501",
            appId: "1:56089233501:web:363348f4daf2b6bb9825b4"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        enableIndexedDbPersistence(db).catch(() => console.log("Persistencia ya habilitada"));

        window.db = db;
        window.auth = auth;
        window.signIn = signInWithEmailAndPassword;
        window.logout = signOut;

        onAuthStateChanged(auth, (user) => {
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('main-app');
            const splash = document.getElementById('splash');

            setTimeout(() => {
                if (splash) splash.style.opacity = '0';
                setTimeout(() => splash?.remove(), 500);
            }, 1500);

            if (user) {
                window.currentUser = user.uid;
                authScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                document.getElementById('display-date').innerText = new Date().toLocaleDateString();
                
                if(window.loadSettings) window.loadSettings();
                if(window.loadInventory) window.loadInventory();
                if(window.loadDraft) window.loadDraft(); // Carga borrador al iniciar
            } else {
                window.currentUser = null;
                authScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
        });
    </script>

    <script src="app.js"></script>

    <script>
        const API_URL = 'https://presupro-v2.onrender.com';

        // SISTEMA KEEP-ALIVE (Mejora para Render)
        function keepAlive() {
            if (API_URL) {
                fetch(`${API_URL}/ping`)
                    .then(() => console.log('Keep-alive: Servidor despierto'))
                    .catch(() => console.log('Keep-alive: Servidor iniciando...'));
            }
        }
        setInterval(keepAlive, 300000); // Ping cada 5 minutos

        function openModal(id) { 
            const modal = document.getElementById(id);
            if(modal) modal.classList.remove('hidden'); 
        }
        function closeModal(id) { 
            const modal = document.getElementById(id);
            if(modal) modal.classList.add('hidden'); 
        }

        // Mejora: Sistema de persistencia local (Draft)
        function saveAndCalc() {
            calcTotal();
            const draft = {
                m2: document.getElementById('mo-m2').value,
                moPrice: document.getElementById('mo-price').value,
                tasa: document.getElementById('tasa-cambio').value,
                cliente: {
                    name: document.getElementById('display-client-name').innerText,
                    id: document.getElementById('in-client-id').value,
                    dir: document.getElementById('in-client-dir').value
                }
            };
            localStorage.setItem('presupro_draft', JSON.stringify(draft));
        }

        window.loadDraft = function() {
            const saved = localStorage.getItem('presupro_draft');
            if(saved) {
                const data = JSON.parse(saved);
                document.getElementById('mo-m2').value = data.m2 || '';
                document.getElementById('mo-price').value = data.moPrice || '';
                document.getElementById('tasa-cambio').value = data.tasa || '60';
                if(data.cliente) {
                    document.getElementById('display-client-name').innerText = data.cliente.name;
                    document.getElementById('in-client-id').value = data.cliente.id;
                    document.getElementById('in-client-dir').value = data.cliente.dir;
                }
                calcTotal();
            }
        };

        function calcTotal() {
            let totalMat = 0;
            document.querySelectorAll('.subtotal-item').forEach(el => {
                const val = parseFloat(el.innerText.replace('$ ', '').replace(',', '.')) || 0;
                totalMat += val;
            });
            
            const m2 = parseFloat(document.getElementById('mo-m2').value) || 0;
            const p2 = parseFloat(document.getElementById('mo-price').value) || 0;
            const totalMO = m2 * p2;
            const tasa = parseFloat(document.getElementById('tasa-cambio').value) || 1;
            
            const totalG = totalMat + totalMO;
            document.getElementById('total-amount').innerText = `$ ${totalG.toFixed(2)}`;
            document.getElementById('total-converted').innerText = `BS ${(totalG * tasa).toFixed(2)}`;
            
            return { totalGeneral: totalG, totalMO: totalMO, tasa: tasa };
        }

        async function enviarAlServidor() {
            const btn = document.getElementById('btn-generate-pdf');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            const materiales = [];
            document.querySelectorAll('.material-row').forEach(row => {
                const nombre = row.querySelector('.nombre-material').value;
                if(nombre) {
                    materiales.push({
                        nombre: nombre,
                        cantidad: row.querySelector('.cantidad-material').value,
                        precio: row.querySelector('.precio-material').value,
                        subtotal: parseFloat(row.querySelector('.subtotal-item').innerText.replace('$ ','').replace(',','.'))
                    });
                }
            });

            const totales = calcTotal();
            const payload = {
                cliente: {
                    nombre: document.getElementById('display-client-name').innerText,
                    id: document.getElementById('in-client-id').value,
                    direccion: document.getElementById('in-client-dir').value
                },
                empresa: {
                    nombre: document.getElementById('display-company').innerText,
                    logo: document.getElementById('logo-img').src
                },
                materiales: materiales,
                manoObra: {
                    metros: document.getElementById('mo-m2').value,
                    precioPorMetro: document.getElementById('mo-price').value,
                    totalMO: totales.totalMO
                },
                totalGeneral: totales.totalGeneral,
                tasa: totales.tasa
            };

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000);

                const res = await fetch(`${API_URL}/generar-presupuesto`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if(!res.ok) throw new Error("Fallo en servidor");

                const html = await res.text();
                const win = window.open('', '_blank');
                win.document.write(html);
                win.document.close();
            } catch (e) {
                alert("Error: Render est谩 despertando o la conexi贸n es lenta. Reintenta en 10 segundos.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function handleLogin() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('btn-login');
            
            btn.disabled = true;
            btn.innerText = "AUTENTICANDO...";
            
            try {
                await window.signIn(window.auth, email, pass);
            } catch (e) { 
                alert("Acceso denegado. Verifica correo y contrase帽a."); 
                btn.disabled = false;
                btn.innerText = "ENTRAR AL SISTEMA";
            }
        }

        function handleLogout() { 
            if(confirm("驴Seguro que deseas cerrar la sesi贸n?")) {
                localStorage.removeItem('presupro_draft'); // Limpia borrador al salir
                window.logout(window.auth);
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log("SW Activo v4"))
                .catch(err => console.log("Error SW:", err));
        }
    </script>
</body>
</html>